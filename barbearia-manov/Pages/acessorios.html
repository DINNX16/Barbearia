<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Acess칩rios e Filtros - Barbearia Man칩v</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Playfair+Display:wght@700&display=swap"
    rel="stylesheet" />

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/> 

  <link rel="stylesheet" href="style/estilo-geral.css" />
  <style>

  </style>
</head>

<body>

  <div id="loading" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background: linear-gradient(135deg, #fef7cd, #fed7aa);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    font-family: 'Montserrat', sans-serif;
    transition: opacity 0.5s ease;
  ">
    <img id="moeda" src="https://raw.githubusercontent.com/DINNX16/Barbearia/main/barbearia-manov/assets/moedamoeda.png"
      alt="Moeda" style="
      width: 150px;
      height: 150px;
      animation: girar 1.5s linear infinite;
      filter: drop-shadow(0 5px 15px rgba(0, 0, 0, 0.3));
    " />
    <h2 style="color: #92400e; margin-top: 20px; font-size: 24px">
      Barbearia Man칩v
    </h2>
    <p style="color: #78350f; font-size: 16px">Carregando...</p>
    <div id="contador" style="
      color: #78350f;
      font-size: 32px;
      font-weight: bold;
      margin-top: 10px;
    ">
      3
    </div>
  </div>


  <header class="header">
    <div class="logo">
      <a href="main.html" style="text-decoration: none; color: inherit">
        <h1>Barbearia Man칩v</h1>
      </a>
    </div>
  </header>
  <main class="main-content">
    <div class="filters-section">
      <div class="filters-header">
        <h2 class="filters-title">游댌 Filtros Avan칞ados</h2>
      </div>
      <div class="results-count" id="resultsCount"></div>
      <div class="filters-container">
<div class="filter-group">
  <h3 class="filter-group-title">Categoria</h3>
  <div class="filter-options">
    <div class="filter-option">
      <input type="checkbox" id="pomadas" name="category" value="pomadas" /><label for="pomadas">Pomadas</label>
    </div>
    <div class="filter-option">
      <input type="checkbox" id="oleos" name="category" value="oleos" /><label for="oleos">칍leos e Shampoos</label>
    </div>
    <div class="filter-option">
      <input type="checkbox" id="ferramentas" name="category" value="ferramentas" /><label for="ferramentas">Ferramentas</label>
    </div>
    <div class="filter-option">
      <input type="checkbox" id="acessorios" name="category" value="acessorios" /><label for="acessorios">Acess칩rios</label>
    </div>
    <div class="filter-option">
      <input type="checkbox" id="maquinas" name="category" value="maquinas" /><label for="maquinas">M치quinas</label>
    </div>
  </div>
</div>
        <div class="filter-group">
          <h3 class="filter-group-title">Faixa de Pre칞o</h3>
          <div class="price-inputs">
            <input type="number" class="price-input" id="minPrice" placeholder="Min R$" min="0" />
            <input type="number" class="price-input" id="maxPrice" placeholder="Max R$" min="0" />
          </div>
        </div>
        <div class="filter-group">
  <h3 class="filter-group-title">Marca</h3>
  <div class="filter-options" id="marca-filter-options">
    </div>
</div>
      </div>
      <div class="filter-actions">
        <button class="btn-filter btn-apply" onclick="applyFilters()">
          Aplicar Filtros
        </button>
        <button class="btn-filter btn-clear" onclick="clearFilters()">
          Limpar Tudo
        </button>
      </div>
    </div>


    <div id="no-results" style="
          display: none;
          text-align: center;
          padding: 40px;
          background: white;
          border-radius: 12px;
          margin: 20px;
        ">
      <h3>Nenhum produto encontrado.</h3>
      <p>Tente alterar ou limpar os filtros.</p>
    </div>

    <div class="expandable-section">
      <h2 class="carousel-title">Destaques da Loja</h2>
      <div class="expandable-container" id="expandable-container-1">
        <div class="expandable-wrapper" id="expandable-wrapper-1"></div>
        <button class="btn-expand" onclick="toggleExpand('expandable-container-1', this)">
          <span id="expand-btn-text">Expandir</span> <i class="arrow"></i>
        </button>
      </div>
    </div>
  </main>

  <footer class="footer">
    <p>춸 2025 Barbearia Man칩v - Todos os direitos reservados</p>
  </footer>

  <script>

    document.addEventListener("DOMContentLoaded", async () => {

    // --- 1. REFER칅NCIAS AOS ELEMENTOS DO HTML ---
    const carouselsWrapper = document.getElementById("carousels-wrapper");
    const expandableWrapper = document.getElementById("expandable-wrapper-1");
    const noResultsDiv = document.getElementById("no-results");
    const resultsCountEl = document.getElementById('resultsCount');

    // --- 2. ESTADO DA APLICA칂츾O ---
    let todosOsProdutos = [];
    let produtosFiltrados = [];

    // --- 3. FUN칂칏ES DE API E DADOS ---
    async function fetchProdutosDaAPI() {
        try {
            const response = await fetch('http://localhost:3000/api/produtos');
            if (!response.ok) throw new Error(`Erro na API: ${response.statusText}`);
            return await response.json();
        } catch (error) {
            console.error("Falha ao carregar produtos da API:", error);
            carouselsWrapper.innerHTML = `<p style="text-align:center; color:red; padding: 2rem;">Ops! N칚o foi poss칤vel carregar os produtos.</p>`;
            return [];
        }
    }

    // --- 4. FUN칂칏ES DE RENDERIZA칂츾O ---
    function createProductCard(product) {
        const precoFormatado = parseFloat(product.preco_venda).toFixed(2).replace(".", ",");
        return `
            <div class="product-card" data-id="${product.id_produto}">
              <div class="product-image">${product.icon || '游닍'}</div>
              <div class="product-info">
                <h3 class="product-title">${product.nome}</h3>
                <div class="product-price">
                  <span class="price">R$ ${precoFormatado}</span>
                  <button class="btn-comprar">Comprar</button>
                </div>
              </div>
            </div>`;
    }

    function renderizarProdutos() {
        // CORRIGIDO: Filtra pela categoria correta 'acessorio' (singular) para o carrossel
        const acessoriosParaDestaque = produtosFiltrados.filter(p => p.categoria === 'acessorio');
        
        const carouselTrackAcessorios = document.getElementById('carousel-track-1');
        if (carouselTrackAcessorios) {
            carouselTrackAcessorios.innerHTML = acessoriosParaDestaque.length > 0 
                ? acessoriosParaDestaque.map(createProductCard).join('') 
                : '<p class="empty-category-msg">Nenhum acess칩rio encontrado.</p>';
        }
        
        // Renderiza a grade expans칤vel com todos os produtos que passaram pelo filtro
        if (expandableWrapper) {
            expandableWrapper.innerHTML = `<div class="expandable-product-grid">${produtosFiltrados.map(createProductCard).join("")}</div>`;
        }

        resultsCountEl.innerHTML = `游꿢 <strong>${produtosFiltrados.length}</strong> produtos encontrados`;
        
        const temResultados = produtosFiltrados.length > 0;
        carouselsWrapper.style.display = temResultados ? "block" : "none";
        expandableWrapper.parentElement.parentElement.style.display = temResultados ? "block" : "none";
        noResultsDiv.style.display = temResultados ? "none" : "block";
    }

    // --- 5. L칍GICA DO CARRINHO ---
    function adicionarAoCarrinho(productId) {
        const produtoParaAdicionar = todosOsProdutos.find(p => p.id_produto === productId);
        if (!produtoParaAdicionar) return;

        let carrinho = JSON.parse(localStorage.getItem('carrinhoManov')) || [];
        const itemExistente = carrinho.find(item => item.id === produtoParaAdicionar.id_produto);

        if (itemExistente) {
            itemExistente.quantity++;
        } else {
            carrinho.push({
                id: produtoParaAdicionar.id_produto,
                name: produtoParaAdicionar.nome,
                price: parseFloat(produtoParaAdicionar.preco_venda) * 100,
                quantity: 1,
                imagem: produtoParaAdicionar.caminho_imagem || 'https://via.placeholder.com/80'
            });
        }
        
        localStorage.setItem('carrinhoManov', JSON.stringify(carrinho));
        window.dispatchEvent(new CustomEvent('cartUpdated'));
        alert(`"${produtoParaAdicionar.nome}" foi adicionado ao carrinho!`);
    }

    // --- 6. FUN칂칏ES GLOBAIS ---

window.applyFilters = function() {
    const selectedCategoriesHTML = Array.from(document.querySelectorAll('input[name="category"]:checked')).map(el => el.value);
    const selectedBrands = Array.from(document.querySelectorAll('input[name="brand"]:checked')).map(el => el.value); // <-- L칡 as marcas selecionadas
    const minPrice = parseFloat(document.getElementById("minPrice").value) || 0;
    const maxPrice = parseFloat(document.getElementById("maxPrice").value) || Infinity;

    // L칩gica de "tradu칞칚o" das categorias
    const categoriasParaBuscar = [];
    if (selectedCategoriesHTML.includes('pomadas') || selectedCategoriesHTML.includes('oleos')) {
        if (!categoriasParaBuscar.includes('cosmetico')) categoriasParaBuscar.push('cosmetico');
    }
    if (selectedCategoriesHTML.includes('ferramentas') || selectedCategoriesHTML.includes('maquinas')) {
        if (!categoriasParaBuscar.includes('equipamento')) categoriasParaBuscar.push('equipamento');
    }
    if (selectedCategoriesHTML.includes('acessorios')) {
        if (!categoriasParaBuscar.includes('acessorio')) categoriasParaBuscar.push('acessorio');
    }

    produtosFiltrados = todosOsProdutos.filter(product => {
        const price = parseFloat(product.preco_venda);
        const categoryMatch = categoriasParaBuscar.length === 0 || categoriasParaBuscar.includes(product.categoria);
        const brandMatch = selectedBrands.length === 0 || selectedBrands.includes(product.marca); // <-- L칩gica de filtro por marca
        const priceMatch = price >= minPrice && price <= maxPrice;
        
        return categoryMatch && brandMatch && priceMatch; // <-- Adicionado brandMatch
    });
    
    renderizarProdutos();
}
    window.clearFilters = function() {
        document.querySelectorAll('input[type="checkbox"]').forEach(el => el.checked = false);
        document.getElementById("minPrice").value = "";
        document.getElementById("maxPrice").value = "";
        produtosFiltrados = [...todosOsProdutos];
        renderizarProdutos();
    }
    
    window.moveSlide = function(direction, carouselIndex) { /* ... l칩gica do carrossel ... */ };


window.toggleExpand = function(containerId, buttonEl) {
    const container = document.getElementById(containerId);
    if (!container) return;

    // A MUDAN칂A: Adicionamos a classe no container PAI
    container.classList.toggle("is-expanded");
    
    // A l칩gica para mudar o texto do bot칚o continua a mesma
    const buttonText = buttonEl.querySelector("span");
    if (container.classList.contains("is-expanded")) {
        buttonText.textContent = "Recolher";
    } else {
        buttonText.textContent = "Expandir";
    }
}

    // --- 7. INICIALIZA칂츾O DA P츼GINA ---
    async function init() {
        todosOsProdutos = await fetchProdutosDaAPI();
        produtosFiltrados = [...todosOsProdutos];
                    renderizarFiltroDeMarcas(todosOsProdutos);
        renderizarProdutos();

    }

    init();

    // Adiciona o Event Listener para os bot칫es "Comprar"
    document.body.addEventListener('click', (event) => {
        if (event.target.classList.contains('btn-comprar')) {
            const card = event.target.closest('.product-card');
            if (card) {
                const productId = parseInt(card.dataset.id);
                adicionarAoCarrinho(productId);
            }
        }
    });

});


/**
 * Cria os filtros de marca dinamicamente baseados nos produtos da API.
 * Apenas marcas com 2 ou mais produtos s칚o exibidas.
 * @param {Array} produtos - A lista completa de produtos vinda da API.
 */
function renderizarFiltroDeMarcas(produtos) {
    const marcaFilterContainer = document.getElementById('marca-filter-options');
    if (!marcaFilterContainer) return;

    // 1. Contar quantas vezes cada marca aparece
    const contadorDeMarcas = {};
    for (const produto of produtos) {
        if (produto.marca) { // Ignora produtos sem marca definida
            contadorDeMarcas[produto.marca] = (contadorDeMarcas[produto.marca] || 0) + 1;
        }
    }

    // 2. Filtrar apenas as marcas que aparecem 2 ou mais vezes
    const marcasValidas = Object.keys(contadorDeMarcas).filter(marca => contadorDeMarcas[marca] >= 2);
    
    // 3. Ordenar as marcas em ordem alfab칠tica
    marcasValidas.sort();

    // 4. Criar o HTML dos filtros e inserir na p치gina
    if (marcasValidas.length > 0) {
        let htmlFiltros = '';
        for (const marca of marcasValidas) {
            const marcaId = `brand-${marca.toLowerCase().replace(/\s+/g, '-')}`;
            htmlFiltros += `
                <div class="filter-option">
                    <input type="checkbox" id="${marcaId}" name="brand" value="${marca}" />
                    <label for="${marcaId}">${marca}</label>
                </div>
            `;
        }
        marcaFilterContainer.innerHTML = htmlFiltros;
    } else {
        marcaFilterContainer.innerHTML = '<p style="font-size: 0.8rem; color: #6c757d;">Nenhuma marca com m칰ltiplos produtos.</p>';
    }
}

  </script>

  <script src="js/auth.js">

  </script>
</body>

</html>